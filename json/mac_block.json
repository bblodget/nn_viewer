{
  "entryPointModule": "mainDiagram",
  "primitiveDefinitions": {
    "delay_chain": {
      "is_primitive": false,
      "parameters": {
        "DELAY": 1,
        "DATA_WIDTH": 1
      },
      "inputs": [
        {"name": "in", "size": "${DATA_WIDTH}"}
      ],
      "outputs": [
        {"name": "out", "size": "${DATA_WIDTH}"}
      ],
      "component_loops": [
        {
          "iterator": "i",
          "range": [0, "${DELAY-1}"],
          "components": [
            {
              "id": "reg_${i}",
              "type": "reg",
              "inputs": {
                "in": "${i == 0 ? '$.in' : 'reg_' + (i-1) + '.out'}"
              }
            }
          ]
        }
      ],
      "outputMappings": {
        "out": "${DELAY > 0 ? 'reg_' + (DELAY-1) + '.out' : '$.in'}"
      },
      "display": {
        "height": 1,
        "color": "#9C27B0",
        "label": "Delay ${DELAY}"
      }
    },
    "add": {
      "is_primitive": true,
      "inputs": [
        {"name": "in1", "size": 1},
        {"name": "in2", "size": 1}
      ],
      "outputs": [
        {"name": "out", "size": 1}
      ],
      "display": {
        "symbol": "+",
        "color": "#4CAF50",
        "shape": "circle"
      }
    },
    "mul": {
      "is_primitive": true,
      "inputs": [
        {"name": "in1", "size": 1},
        {"name": "in2", "size": 1}
      ],
      "outputs": [
        {"name": "out", "size": 1}
      ],
      "display": {
        "symbol": "×",
        "color": "#2196F3",
        "shape": "circle"
      }
    },
    "reg": {
      "is_primitive": true,
      "inputs": [
        {"name": "in", "size": 1}
      ],
      "outputs": [
        {"name": "out", "size": 1}
      ],
      "display": {
        "symbol": "D",
        "color": "#9C27B0",
        "shape": "rect"
      }
    },
    "relu2": {
      "is_primitive": true,
      "inputs": [
        {"name": "in", "size": 1}
      ],
      "outputs": [
        {"name": "out", "size": 1}
      ],
      "display": {
        "symbol": "ReLU²",
        "color": "#FF9800",
        "shape": "rect"
      }
    },
    "clamp": {
      "is_primitive": true,
      "inputs": [
        {"name": "in", "size": 1}
      ],
      "outputs": [
        {"name": "out", "size": 1}
      ],
      "display": {
        "symbol": "◊",
        "color": "#F44336",
        "shape": "diamond"
      }
    }
  },
  "moduleDefinitions": {
    "macBlock": {
      "is_primitive": false,
      "parameters": {
        "PAIRS": 2,
        "DATA_WIDTH": 1
      },
      "inputs": [
        {"name": "x0", "size": "${DATA_WIDTH}", "group": "pair1"},
        {"name": "w0", "size": "${DATA_WIDTH}", "group": "pair1"},
        {"name": "x1", "size": "${DATA_WIDTH}", "group": "pair2"},
        {"name": "w1", "size": "${DATA_WIDTH}", "group": "pair2"}
      ],
      "outputs": [
        {"name": "out", "size": 1}
      ],
      "port_groups": {
        "pair1": {
          "ports": ["x0", "w0"],
          "arrangement": "interleaved"
        },
        "pair2": {
          "ports": ["x1", "w1"],
          "arrangement": "interleaved"
        }
      },
      "display": {
        "height": 2,
        "color": "#7986CB",
        "label": "MAC (${PAIRS}x)"
      },
      "components": [
        {
          "id": "mul0",
          "type": "mul",
          "inputs": {
            "in1": "$.x0",
            "in2": "$.w0"
          }
        },
        {
          "id": "mul1",
          "type": "mul",
          "inputs": {
            "in1": "$.x1",
            "in2": "$.w1"
          }
        },
        {
          "id": "add1",
          "type": "add",
          "inputs": {
            "in1": "mul0.out",
            "in2": "mul1.out"
          }
        }
      ],
      "outputMappings": {
        "out": "add1.out"
      }
    },
    "mainDiagram": {
      "is_primitive": false,
      "parameters": {
        "COMPUTE_WIDTH": 1
      },
      "inputs": [
        {"name": "x0", "size": "${COMPUTE_WIDTH}", "group": "inputs"},
        {"name": "w0", "size": "${COMPUTE_WIDTH}", "group": "weights"},
        {"name": "x1", "size": "${COMPUTE_WIDTH}", "group": "inputs"},
        {"name": "w1", "size": "${COMPUTE_WIDTH}", "group": "weights"},
        {"name": "bias", "size": 1},
        {"name": "scale", "size": 1}
      ],
      "outputs": [
        {"name": "out", "size": 1}
      ],
      "port_groups": {
        "inputs": {
          "ports": ["x0", "x1"],
          "arrangement": "sequential",
          "color": "#4CAF50"
        },
        "weights": {
          "ports": ["w0", "w1"],
          "arrangement": "sequential",
          "color": "#2196F3"
        }
      },
      "components": [
        {
          "id": "macBlock1",
          "type": "macBlock",
          "parameters": {
            "PAIRS": 2,
            "DATA_WIDTH": "${COMPUTE_WIDTH}"
          },
          "label": "MAC Block",
          "inputs": {
            "x0": "$.x0",
            "w0": "$.w0",
            "x1": "$.x1",
            "w1": "$.w1"
          }
        },
        {
          "id": "bias_delay",
          "type": "delay_chain",
          "parameters": {
            "DELAY": 2,
            "DATA_WIDTH": 1
          },
          "inputs": {
            "in": "$.bias"
          }
        },
        {
          "id": "add2",
          "type": "add",
          "inputs": {
            "in1": "macBlock1.out",
            "in2": "bias_delay.out"
          }
        },
        {
          "id": "relu1",
          "type": "relu2",
          "inputs": {
            "in": "add2.out"
          }
        },
        {
          "id": "scale_delay",
          "type": "delay_chain",
          "parameters": {
            "DELAY": 4,
            "DATA_WIDTH": "${COMPUTE_WIDTH}"
          },
          "inputs": {
            "in": "$.scale"
          }
        },
        {
          "id": "mul2",
          "type": "mul",
          "inputs": {
            "in1": "relu1.out",
            "in2": "scale_delay.out"
          }
        },
        {
          "id": "clamp1",
          "type": "clamp",
          "inputs": {
            "in": "mul2.out"
          }
        }
      ],
      "outputMappings": {
        "out": "clamp1.out"
      }
    }
  }
}